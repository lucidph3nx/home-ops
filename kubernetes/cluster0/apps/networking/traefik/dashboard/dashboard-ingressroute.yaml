# apiVersion: traefik.io/v1alpha1
# kind: Middleware
# metadata:
#   name: traefik-dashboard-addprefix
#   namespace: networking
# spec:
#   addPrefix:
#     prefix: /dashboard
#
# ---
#
# apiVersion: traefik.io/v1alpha1
# kind: IngressRoute
# metadata:
#   name: traefik-dash-ingress
#   namespace: networking
# spec:
#   entryPoints:
#     - websecure
#   routes:
#     - match: "(Host(`traefik.${SECRET_PUBLIC_DOMAIN}`) && !PathPrefix(`/api`))"
#       kind: Rule
#       middlewares:
#         - name: forwardauth-authelia
#           namespace: auth
#         - name: traefik-dashboard-addprefix
#           namespace: networking
#       services:
#         - name: api@internal
#           kind: TraefikService
#     # separate route for api without dash prefix removed
#     - match: "(Host(`traefik.${SECRET_PUBLIC_DOMAIN}`) && PathPrefix(`/api`))"
#       kind: Rule
#       middlewares:
#         - name: forwardauth-authelia
#           namespace: auth
#       services:
#         - name: api@internal
#           kind: TraefikService
#   tls:
#     secretName: "${SECRET_PUBLIC_DOMAIN/./-}-tls"

---
# switch to httproute
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: traefik-dashboard
  namespace: networking
spec:
  hostnames: 
  - "traefik.${SECRET_PUBLIC_DOMAIN}"
  parentRefs:
    - group: gateway.networking.k8s.io
      kind: Gateway
      name: traefik-gateway
      namespace: networking
      sectionName: websecure
  rules:
  - matches:
      - path:
          type: PathPrefix
          value: /api
    filters:
      - type: ExtensionRef
        extensionRef:
          group: traefik.io
          kind: Middleware
          name: forwardauth-authelia
    backendRefs:
      - group: ""
        kind: Service
        name: traefik
        namespace: networking
        port: 8080
  - matches:
      - path:
          type: PathPrefix
          value: /
    filters:
      - type: URLRewrite
        urlRewrite:
          path:
            type: ReplacePrefixMatch
            replacePrefixMatch: /dashboard/
      - type: ExtensionRef
        extensionRef:
          group: traefik.io
          kind: Middleware
          name: forwardauth-authelia
    backendRefs:
      - group: ""
        kind: Service
        name: traefik
        namespace: networking
        port: 8080
